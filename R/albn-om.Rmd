---
title: "North Atlanic Albacore"
subtitle: "Operating Model"
author: "Laurence Kell"
date: "26/03/2015"
output: html_document
---

```{r, echo=FALSE}
library(knitr)

opts_chunk$set(comment=NA, 
               fig.width =6, 
               fig.height=6,
               fig.path  ="../tex/",
               warning=FALSE, 
               message=FALSE, 
               error  =FALSE, 
               echo   =FALSE, 
               eval   =TRUE,
               cache  =TRUE)
```

```{r, echo=FALSE}
library(FLCore)
library(ggplotFL)
library(plyr)
library(reshape)
library(FLBRP)
library(biodyn)
library(scales)
library(kobe)

theme_set(theme_bw(10))

dirMy ="C:/temp/albn"
dirDat=paste(dirMy,"/data",sep="")
```

```{r,eval=FALSE}
load("C:/temp/albn/data/ALB.RData")
om=ALB
rm(ALB)

save(om,file=paste(dirDat,"om.RData",sep="/"))
```

```{r}
load(paste(dirDat,"om.RData",sep="/"))
```


```{ralbn-om,fig.width=8}
ggplot(ldply(om, function(x) as.data.frame(FLQuants(x,
                              Recruits=rec,
                              SSB     =ssb,
                              Biomass =stock,
                              F       =fbar,
                              Fapex   =fapex,
                              Catch   =catch))))+
         geom_line(aes(year,data,col=.id))+
         facet_grid(qname~.,scale="free_y")+
         theme_bw(10)
```

**Figure 1** Time series of recruits, SSB, biomass, mean F, F apex and Catch

```{ralbn-om-sr}
srs=FLSRs(llply(om,as.FLSR,model="bevholt"))
srs=FLSRs(llply(srs, fmle,control=list(silent=TRUE)))
names(srs)=names(om)

plot(srs[["Base"]])
```

**Figure 2**  Stock recruitment fit with diagnostics for base case.

```{ralbn-om-eql,fig.width=8}
eql=FLBRPs(mlply(names(srs),function(i) 
  brp(FLBRP(om[[i]],sr=srs[[i]],nyears=dims(om[[i]])$year))))
names(eql)=names(om)
plot(eql,refpts=FALSE)+theme_bw(10)
```

**Figure 3**  Equilibrium curves


```{ralbn-om-biol,fig.width=8}
names(eql)=names(om)
biol=ldply(eql, function(x) as.data.frame(x[["catch.sel","m","mat","stock.wt"]]))
biol=transform(biol,
               Quantity=factor(qname,labels=c("Selectivity","M","Maturity","Mass")),
               .id     =names(om)[X1])
ggplot(biol)+
  geom_line(aes(age,data,group=.id,col=.id))+ 
  facet_wrap(~Quantity,scale="free_y")+ 
  theme_bw()+
  scale_colour_discrete(name="Scenario")+
  xlab("Age") +ylab("")
```

**Figure 4**  Future parameter vectors

# Comparison with biomass dynamic model

```{ralbn-om-prd,fig.height=4}
FLBRP2biodyn=function(from){
  
  ## age based regference points
  msy =c(from@refpts["msy",   "yield"])
  bmsy=c(from@refpts["msy",   "biomass"])
  k   =c(from@refpts["virgin","biomass"])
  
  # biomass based reference points
  p   =optimise(function(p,bmsy,k) 
    (bmsy-k*(1/(1+p))^(1/p))^2, c(0.001,5), bmsy=bmsy,k=k)$minimum
  k=bmsy/((1/(1+p))^(1/p))
  r=msy/(k*(1/(1+p))^(1/p+1))
  b0=mean(stock(from)[,1:5]/k)
  
  bd=biodyn()
  
  bd@params=FLPar(c(r=r,k=k,p=p,b0=b0))
  
  bd@catch=catch.obs(from)
  bd@stock=from@stock.obs
  
  range(bd)["minyear"]=dims(bd@catch)$minyear
  range(bd)["maxyear"]=dims(bd@catch)$maxyear
  
  bd}

bd=FLBRP2biodyn(eql[["Base"]])
bd=fwd(bd,catch=catch(bd)[,-c(1,82)])

cpue =stock(om[["Base"]])
catch=catch(om[["Base"]])

fbar(eql[["Base"]])=fbar(eql[["Base"]])/max(fbar(eql[["Base"]]))*.5
eql[["Base"]]=brp(eql[["Base"]])

dat=model.frame(FLQuants(bd,"stock","catch"))

plotPrd(bd)+
  geom_path( aes(stock,catch),data=dat)+
  geom_path(aes(stock,catch),
            data=model.frame(FLQuants(bd,"stock","catch")))+
  geom_path(aes(stock,catch),
             data=subset(model.frame(FLQuants(eql[["Base"]],"stock","catch")),
                         stock>0),col="blue")+
  theme_bw(10)
```

**Figure 5** Comparison of age based and Pella Tomlinson production functions.


```{ralbn-om-mp}
fapexAge<-function(object){
  tmp=harvest(object)
  tmp[]=fapex(object)
  tmp=FLQuant(ages(tmp)[harvest(object)==tmp],
              dimnames=dimnames(fapex(object)))
  tmp}


dat=
  rbind.fill(cbind(What="MP", as.data.frame(FLQuants(bd,      "catch","harvest","stock"))),
             cbind(What="OM", as.data.frame(FLQuants(om[["Base"]],"catch","harvest"=function(x)
               catch(x)/stock(x),"stock"))))

ggplot(dat)+geom_line(aes(year,data,col=What))+
  facet_grid(qname~.,scale="free")
```

**Figure 6** Simulation with biomass production function


```{r}
bry=eql[["Base"]]
landings.sel(bry)=propagate(iter(landings.sel(bry),1),82)
landings.sel(bry)[]=harvest(om[["Base"]])

tmp=model.frame(computeRefpts(bry)["msy",1:5])
tmp=rbind.fill(tmp,
          transform(as.data.frame(fapexAge(om[["Base"]]),drop=T),
          msy=data,iter=year-1929,quantity="Fapex Age")[,c(3:5)])
tmp=rbind.fill(tmp,
               transform(as.data.frame(computeRefpts(bry)["msy","biomass"]/
                                       computeRefpts(bry)["virgin","biomass"]),
                         msy=data,quantity="shape")[,c(2:3,5)])
tmp=rbind.fill(tmp,
               transform(as.data.frame(computeRefpts(bry)["msy","yield"]/
                                       computeRefpts(bry)["msy","biomass"]),
                         msy=data,quantity="hrate")[,c(2:3,5)])

bdt=maply(1:82,function(i) FLBRP2biodyn(iter(bry,i))@params[c("r","k","p")])

bdt=melt(bdt)
names(bdt)=c("iter","quantity","msy")
bdt=rbind(tmp,bdt)
names(bdt)[1]="data"
```

```{ralbn-om-bench1,fig.width=8}
ggplot(bdt)+
  geom_line(aes(as.numeric(as.numeric(iter)+1929),data))+
  facet_wrap(~quantity,scale="free",ncol=2)+
  xlab("Year")+ylab("")+
  theme_bw(10)
```

**Figure 7** Time series of population parameters


```{ralbn-om-bench2,fig.width=8}
ggplot(ddply(subset(bdt,!(quantity%in%c("Fapex Age","p"))),
        .(quantity), transform, data=(data-mean(data))/mean(data)))+
  geom_line(aes(as.numeric(as.numeric(iter)+1929),data))+
  facet_wrap(~quantity,scale="free",ncol=2)+
  xlab("Year")+ylab("")+
  theme_bw(10)+
  scale_y_continuous(labels=percent)+
  geom_hline(aes(yintercept=0),col="grey")
```

**Figure 8** Relative time series of population parameters

```{r}
productionFn=function(object,stk="missing",
                      slots=c("landings.sel","discards.sel",
                              "stock.wt","landings.wt","discards.wt",
                              "m","mat",
                              "harvest.spwn","m.spwn")){
  
  nyr=dim(biomass.obs(object))[2]
  
  prd=biomass.obs(object)[,-nyr]+
    catch.obs(  object)[,-nyr]-
    biomass.obs(object)[,-1]
  
  ref               =FLBRP:::refpts(object)[1,]
  dimnames(ref)[[1]]="biomass"
  ref               =propagate(ref,nyr-1)
  ref[]             =NA
  ref[,"biomass"]   =biomass.obs(object)[,-nyr]
  refpts(object)    =ref
  
  if (!missing(stk)){
    for (i in slots[!(slots%in%c("landings.sel","discards.sel"))]){
      slot(object,i)=propagate(slot(object,i),dims(ref)$iter)
      slot(object,i)[]=slot(stk,i)[,-nyr]
    }
    
    if (any(c("landings.sel","discards.sel")%in%slots)){
      sel=harvest(stk)[,-nyr]
      sel=sel%/%apply(sel[ac(range(stk)["minfbar"]:range(stk)["maxfbar"])],2,mean)
      
      if ("landings.sel"%in%slots){
        landings.sel(object)  =propagate(landings.sel(object),dims(ref)$iter)
        landings.sel(object)[]=sel*landings.n(stk)[,-nyr]/catch.n(stk)[,-nyr]}
      
      if ("discards.sel"%in%slots){
        discards.sel(object)  =propagate(discards.sel(object),dims(ref)$iter)
        discards.sel(object)[]=sel*discards.n(stk)[,-nyr]/catch.n(stk)[,-nyr]}
    }
  }
  
  refpts(object)=computeRefpts(object)
  
  res=cbind(as.data.frame(biomass.obs(object)[,-nyr],drop=T)[,c("year","data")],
            as.data.frame(ssb.obs(    object)[,-nyr],drop=T)[,c("data")],
            as.data.frame(catch.obs(  object)[,-nyr],drop=T)[,"data"],
            as.data.frame(rec.obs(    object)[,-nyr],drop=T)[,"data"],
            as.data.frame(biomass.obs(object)[,-nyr]-
                          ssb.obs(    object)[,-nyr],drop=T)[,"data"],
            as.data.frame(prd,drop=T)[,"data"],
            model.frame(FLBRP:::refpts(object)[,"yield"])[,"biomass"])
  
  names(res)=c("year","biomass","ssb","catch","rec","juve","obs","hat")
  
  res[,c("year","biomass","ssb","juve","rec","catch","obs","hat")]}

#' production
#'
#' @description Estimates estimates surplus production based on equilibrium analysis 
#' 
#' @param   object an object of class \code{FLBRP}
#' @param   stk an \code{FLStock}
#' @param   slots if provides then allows for non-stationarity by using the observed 
#' parameters each year, rather than the averages in  \code{FLBRP}
#'
#' @export
#' @rdname production
#'
#' @details Returns a data.frame with catch, biomass, observed (obs) and
#' expected (hat) production by year 
#' @examples
#' \dontrun{
#'    prd=production(x)
#' }

setGeneric('production',   function(object,stk,...) standardGeneric('production'))

setMethod('production', signature(object='FLBRP',stk='missing'),
          function(object,stk) productionFn(object,stk))

setMethod('production', signature(object='FLBRP',stk='FLStock'),
         function(object,stk,slots=c("landings.sel","discards.sel",
                                     "stock.wt","landings.wt","discards.wt",
                                     "m","mat",
                                     "harvest.spwn","m.spwn"))
         productionFn(object,stk,slots))
          
```


```{ralbn-om-rec,fig.width=8,fig.height=4}
res1=production(object=eql[["Base"]])
res2=production(object=eql[["Base"]],om[["Base"]])

dat=merge(res1,as.data.frame(rec(om[["Base"]]),drop=T))
names(dat)[c(4,6)]=c("Production","Recruitment")

ggplot(dat)+
  geom_line(aes(year,Recruitment),col="grey")+
  geom_point(aes(year,Recruitment))+
  theme_bw()
```

**Figure 9** Recruitment in base case


```{ralbn-sp,fig.width=8,fig.height=4}
ggplot(res1)+geom_line( aes(year,hat))+
             geom_point(aes(year,obs))+
             geom_line( aes(year,hat),data=res2,col="red")+
  theme_bw()   
```

**Figure 10** Surplus production, lines are expected values (red is the non-stationary function) and points are the observered values. CV is `r as.integer(sd(log(res1$obs),na.rm=T)*100)` %


```{ralbn-om-ccf,fig.width=8,fig.height=6}
par(mfrow=c(2,2),mar=c(2,2,4,2))
with(dat,acf(rec))
with(dat,acf(obs))
with(dat,ccf(rec,obs))
```

**Figure 11** Auto and cross correlation for recruitment and production, showing production is driven by recruitment 5 to 10 years earlierand that although recruitment exhibits white noise there is autocorrelation in productivity.

```{r,fig.width=8,fig.height=4,eval=FALSE}
ggplot(spectra(dat$Recruitment))+
  geom_point(aes(f,mx))+
  theme_bw()

ggplot(spectra(dat$Production))+
  geom_point(aes(f,mx)sa)+
  theme_bw()

**Figure** Spectra for production
```


```{ralbn-stars-rec,fig.width=8}
#==Cody Szuwalski, 10/18,2012
#==this function identifies the first regime shift in a series given a significance level
#==based on a t-distribution (sig) and an assumed regime length (regLN) 
#==It must be used iteratively to identify all shifts in a time series (see example)

#==The key differences between this algorithm and STARS (Rodionov, 2004) is that 
#==when a new regime is detected, the algorithm begins searching at n+regimeLength,
#==where  is the first year of the regime identified and regimeLength is the 
#==assumed minimum length of a regime.  The original STARS begins searching at n+1.
#==Additionally, a 'Huber parameter' (which adjusts the influence of outliers)
#==is not included in this version of the algorithm.  

ROregimeSHFT<-function(regLN,sig,series,shift=0){
 Shifts<-0
 startyr <-1
 if(shift!=0) {startyr<-shift}
for (i in seq(startyr,(length(series)-(regLN)) ) )
{
window<-series[i:(regLN+(i-1))]
basemean<-mean(window,na.rm=T)
basevar<-var(window,na.rm=T)
val<-sig*sqrt(2*basevar/regLN)

# the below line would be changed to something like:
# if (series[i+1] > basemean+val | series[i+1] <basemean-val)
# for the original algorithm (I have not valed this)

if (series[regLN+i] > basemean+val | series[regLN+i] <basemean-val)
 { 
 RSI<-0
 if (series[regLN+i] > basemean+val)
  {
   newmean<-basemean+val
   RSI<-(series[regLN+i]-newmean)/(regLN*(sqrt(basevar)))
   down<-0} else
  {
   newmean<-basemean-val
   RSI<-(newmean-series[regLN+i])/(regLN*(sqrt(basevar)))
   down<-1
  }

 origSIGN<-sign(RSI)
 counter<-min(regLN-1,(length(series)-(regLN+(i-1))))
 RSI<-0
 for (j in 1:counter)
   { 
    Shifts<-0
    if(down==0)
    {RSI<- RSI + (series[regLN+i+j-1]-newmean)/(regLN*(sqrt(basevar)))}else
    {RSI<- RSI + (newmean-series[regLN+i+j-1])/(regLN*(sqrt(basevar)))}


   if (sign(RSI)!=origSIGN | RSI == Inf) {break}
   if (j == counter)
    {
    Shifts<-i
    break
    }
   }
  }
  if(Shifts!=0) {break}
 }
return(Shifts)
}

#==the 'Shifts' returned from "ROregimeSHFT" is the index (year) the length of 
#==the assumed regime before the regime occurs
#==that is, if Shift[1]==3, and the assumed regime length is 10
#==the regime shift occurs in year 13.

#==if ROregimeSHFT doesn't find a shift, it returns zero
#==the last entry in 'Shifts' (returned from the function) is either '0' or a value
#==for a year where there is a potential, but unconfirmed shift

#===============================================
#===example aplication=========================
#==============================================

#==an example time series==
# valMean<-0
# valMean2<-1
# valSD1<-0.5
# valSD2<-0.5
# val   <-c(rnorm(12,valMean,valSD1),rnorm(12,valMean2,valSD2),rnorm(12,valMean,valSD1))  		
# plot(val,type="l")
# 

rod=function(val,year=NULL){
#==set the assumed minimum regime length==
rgLN<-10

#== 'sig' should be based on an appropriate t-distribution given
#== the number of observations in the series (but I didn't do that here)
#== this significance level is roughly equal to p<0.1
sig<-1.68

#==iteration for finding all the shifts in a time series==
Shift<-rep(NA,100)							# vector for recording shifts
 if(length(val)>rgLN)
 {
  try(Shift[1]<-ROregimeSHFT(regLN=rgLN,sig=1.68,series=val),TRUE)
  counts<-2
  if(is.na(Shift[counts-1])==FALSE) 
  {
   while(Shift[counts-1]>0 & (Shift[counts-1]+rgLN+rgLN-1)<length(val))
    {
     Shift[counts]<-ROregimeSHFT(rgLN,sig,val,(Shift[counts-1]+rgLN-1))
     counts<-counts+1
    }
   }
  }   

#===plot results=== 

ShiftsVec<-Shift[!is.na(Shift)]

if (!FALSE)
plot(val,type="l")
mn=NULL
sd=NULL
ln=NULL

for(i in 1:length(ShiftsVec))
  {
  if(i==1){  
     regMean<-mean(val[1:(Shift[i]+rgLN-1)])
     regSD<-sd(val[1:(Shift[i]+rgLN-1)])
     mn=c(mn,regMean)
     sd=c(sd,regSD)
     ln=c(ln,Shift[i]+rgLN-1)
     
     if (!FALSE)
       polygon(x=c(1,Shift[i]+rgLN-1,Shift[i]+rgLN-1,1),
     y=c(regMean+regSD,regMean+regSD,regMean-regSD,regMean-regSD),
     border=NA,col="#0000ff55")
    }

  if(i>1){
    endInd<-ShiftsVec[i]+rgLN-1
    if(is.na(ShiftsVec[i+1]))
       {endInd<-length(val)}
     
    regMean<-mean(val[(Shift[i-1]+rgLN):endInd])
    regSD  <-sd(  val[(Shift[i-1]+rgLN):endInd])
    mn=c(mn,regMean)
    sd=c(sd,regSD)
    ln=c(ln,endInd)
     
    if (!FALSE)
      polygon(x=c(Shift[i-1]+rgLN,
               endInd,
               endInd,         
               Shift[i-1]+rgLN),
           y=c(regMean+regSD,
               regMean+regSD,
               regMean-regSD,
               regMean-regSD),
    border=NA,col="#0000ff55")}
    
print(ln)
}

minyear=c(year[1],year[rev(rev(ln)[-1])]+1)
maxyear=min(year)+ln-1

return(data.frame(mn=mn,sd=sd,i=factor(seq(length(mn))),
                  ln=ln,minyear=minyear,maxyear=maxyear))}


res=rod(dat$rec,dat$year)
```

**Figure 12** Shifts in recruitment

```{ralbn-stars-prod,fig.width=8}
res=rod(dat$obs,dat$year)
```
**Figure 13 ** Shifts in production


```{r}
refs=transform(ldply(eql, function(x) FLBRP:::refpts(x)["msy",1:5,drop=T]))

ts=ldply(om, function(x) model.frame(FLQuants(x,"stock","ssb","catch","fbar","rec"),drop=T))
ts=merge(ts,refs,by=".id")
ts=transform(ts,stock  = stock/biomass,
                ssb    = ssb.x/ssb.y,
                catch  = catch/yield,
                harvest=(catch/stock)/(yield/biomass),
                f      =harvest/harvest,
                rec    =rec.x/rec.y)[,c(".id","year","stock","ssb","catch","harvest","f","rec")]
```

```{ralbn-om-harvest,fig.width=8}
quads<- rbind(data.frame(x=c(-Inf,-Inf,Inf,Inf), y=c(-Inf,  1,  1,-Inf), 
                         fill=as.factor("green")),
              data.frame(x=c(-Inf,-Inf,Inf,Inf), y=c(   1,Inf,Inf,   1), 
                         fill=as.factor("red")))

ggplot(ts)+
  geom_polygon(data=quads,aes(x,y,fill=fill)) +
  scale_fill_manual(values = c("lightgreen","pink"), guide="none") +  
  geom_line(aes(year,harvest,group=.id))+
  facet_wrap(~.id)+
  ylab(expression(Harvest/H[MSY]))+
  xlab("Year")
```

**Figure 14** Harvest rate relative to MSY benchmark by scenario.


```{ralbn-om-biomass,fig.width=8}
ggplot(ts)+
  geom_polygon(data=quads,aes(x,y,fill=fill)) +
  scale_fill_manual(values = c("pink","lightgreen"), guide="none") +  
  geom_line(aes(year,harvest,group=.id))+
  facet_wrap(~.id)+
  ylab(expression(Biomass/B[MSY]))+
  xlab("Year")
```

**Figure 15** Stock biomass relative to MSY benchmark by scenario.

```{ralbn-om-k2pp}
kobePhase(ts)+
  geom_path(aes(stock,harvest,group=.id))+
  facet_wrap(~.id)+
  ylab(expression(Harvest/H[MSY]))+
  xlab(expression(Biomass/B[MSY]))
```

**Figure 16** Kobe Phase Plots by scenario

## Recriutment regimes
```{r,fig.width=8}
recRegime=ldply(om, function(x) with(as.data.frame(rec(x),drop=T),rod(data,year)))

save(om,eql,recRegime,file=paste(dirDat,"om.RData",sep="/"))
```
