---
title: "North Atlanic Albacore"
subtitle: "Operating Model"
author: "Laurence Kell"
date: "26/03/2015"
output: html_document
---

```{r, echo=FALSE}
library(knitr)

opts_chunk$set(comment=NA, 
               fig.width =6, 
               fig.height=6,
               fig.path  ="../tex/",
               warning=FALSE, 
               message=FALSE, 
               error  =FALSE, 
               echo   =FALSE, 
               eval   =TRUE,
               cache  =TRUE)
```

```{r, echo=FALSE}
library(FLCore)
library(ggplotFL)
library(plyr)
library(reshape)
library(FLBRP)
library(biodyn)
library(scales)
library(lh)
library(kobe)

theme_set(theme_bw(10))
```

```{r}
dirMy ="/home/laurie/MEGAsync/mse/albn"
dirDat=paste(dirMy,"/data",sep="")

load(paste(dirDat,"alb.RData",sep="/"))
```


```{ralbn-om,fig.width=8}
ggplot(ldply(alb, function(x) as.data.frame(FLQuants(x,
                              Recruits=rec,
                              SSB     =ssb,
                              Biomass =stock,
                              F       =fbar,
                              Fapex   =fapex,
                              Catch   =catch))))+
         geom_line(aes(year,data,col=.id))+
         facet_grid(qname~.,scale="free_y")+
         theme_bw(10)
```

**Figure 1** Time series of recruits, SSB, biomass, mean F, F apex and Catch

```{ralbn-om-sr}
srs=FLSRs(llply(alb,as.FLSR,model="bevholt"))
srs=FLSRs(llply(srs, fmle,control=list(silent=TRUE)))
names(srs)=names(alb)

plot(srs[[9]])
```

**Figure 2**  Stock recruitment fit with diagnostics for base case.

```{ralbn-om-eql,fig.width=8}
brs=FLBRPs(mlply(names(srs),function(i) 
  brp(FLBRP(alb[[i]],sr=srs[[i]],nyears=dims(alb[[i]])$year))))
names(brs)=names(alb)
plot(brs,refpts=FALSE)+theme_bw(10)

save(brs,file=paste(dirDat,"brs.RData",sep="/"))
```

**Figure 3**  Equilibrium curves


```{ralbn-om-biol,fig.width=8}
names(brs)=names(alb)
biol=ldply(brs, function(x) as.data.frame(x[["catch.sel","m","mat","stock.wt"]]))
biol=transform(biol,
               Quantity=factor(qname,labels=c("Selectivity","M","Maturity","Mass")),
               .id     =names(alb)[X1])
ggplot(biol)+
  geom_line(aes(age,data,group=.id,col=.id))+ 
  facet_wrap(~Quantity,scale="free_y")+ 
  theme_bw()+
  scale_colour_discrete(name="Scenario")+
  xlab("Age") +ylab("")
```

**Figure 4**  Future parameter vectors

# Comparison with biomass dynamic model

```{ralbn-om-prd,fig.height=4}
bd=biodyn:::FLBRP2biodyn(brs[["Base"]])
bd=fwd(bd,catch=catch(bd)[,-c(1,82)])

cpue =stock(alb[["Base"]])
catch=catch(alb[["Base"]])
save(bd,   file="/home/laurie/MEGAsync/mse/albn/data/bd.RData")
save(cpue, file="/home/laurie/MEGAsync/mse/albn/data/cpue.RData")
save(catch,file="/home/laurie/MEGAsync/mse/albn/data/catch.RData")

fbar(brs[["Base"]])=fbar(brs[["Base"]])/max(fbar(brs[["Base"]]))*.5
brs[["Base"]]=brp(brs[["Base"]])

dat=model.frame(FLQuants(bd,"stock","catch"))

plotPrd(bd)+
  geom_path( aes(stock,catch),data=dat)+
  geom_path(aes(stock,catch),
            data=model.frame(FLQuants(bd,"stock","catch")))+
  geom_path(aes(stock,catch),
             data=subset(model.frame(FLQuants(brs[["Base"]],"stock","catch")),
                         stock>0),col="blue")+
  theme_bw(10)
```

**Figure 5** Comparison of age based and Pella Tomlonson production functions.


```{ralbn-om-mp}
fapexAge<-function(object){
  tmp=harvest(object)
  tmp[]=fapex(object)
  tmp=FLQuant(ages(tmp)[harvest(object)==tmp],
              dimnames=dimnames(fapex(object)))
  tmp}


dat=
  rbind.fill(cbind(What="MP", as.data.frame(FLQuants(bd,      "catch","harvest","stock"))),
             cbind(What="OM", as.data.frame(FLQuants(alb[["Base"]],"catch","harvest"=function(x)
               catch(x)/stock(x),"stock"))))

ggplot(dat)+geom_line(aes(year,data,col=What))+
  facet_grid(qname~.,scale="free")
```

**Figure 6** Simulation with biomass production function


```{r}
bry=brs[["Base"]]
landings.sel(bry)=propagate(iter(landings.sel(bry),1),82)
landings.sel(bry)[]=harvest(alb[["Base"]])

tmp=model.frame(computeRefpts(bry)["msy",1:5])
tmp=rbind.fill(tmp,
          transform(as.data.frame(fapexAge(alb[["Base"]]),drop=T),
          msy=data,iter=year-1929,quantity="Fapex Age")[,c(3:5)])
tmp=rbind.fill(tmp,
               transform(as.data.frame(computeRefpts(bry)["msy","biomass"]/
                                       computeRefpts(bry)["virgin","biomass"]),
                         msy=data,quantity="shape")[,c(2:3,5)])
tmp=rbind.fill(tmp,
               transform(as.data.frame(computeRefpts(bry)["msy","yield"]/
                                       computeRefpts(bry)["msy","biomass"]),
                         msy=data,quantity="hrate")[,c(2:3,5)])

bdt=maply(1:82,function(i) biodyn:::FLBRP2biodyn(iter(bry,i))@params[c("r","k","p")])

bdt=melt(bdt)
names(bdt)=c("iter","quantity","msy")
bdt=rbind(tmp,bdt)
names(bdt)[1]="data"
```

```{ralbn-om-bench1,fig.width=8}
ggplot(bdt)+
  geom_line(aes(as.numeric(as.numeric(iter)+1929),data))+
  facet_wrap(~quantity,scale="free",ncol=2)+
  xlab("Year")+ylab("")+
  theme_bw(10)
```

**Figure 7** Time series of population parameters


```{ralbn-om-bench2,fig.width=8}
ggplot(ddply(subset(bdt,!(quantity%in%c("Fapex Age","p"))),
        .(quantity), transform, data=(data-mean(data))/mean(data)))+
  geom_line(aes(as.numeric(as.numeric(iter)+1929),data))+
  facet_wrap(~quantity,scale="free",ncol=2)+
  xlab("Year")+ylab("")+
  theme_bw(10)+
  scale_y_continuous(labels=percent)+
  geom_hline(aes(yintercept=0),col="grey")
```

**Figure 8** Relative time series of population parameters

```{r}
source('~/Desktop/flr/git/FLBRP/R/FLBRP-production.R')
```


```{ralbn-om-rec,fig.width=8,fig.height=4}
res1=production(object=brs[[9]])
res2=production(object=brs[[9]],alb[[9]])

dat=merge(res1,as.data.frame(rec(alb[[9]]),drop=T))
names(dat)[c(4,6)]=c("Production","Recruitment")

ggplot(dat)+
  geom_line(aes(year,Recruitment),col="grey")+
  geom_point(aes(year,Recruitment))+
  theme_bw()
```

**Figure 9** Recruitment in base case


```{ralbn-sp,fig.width=8,fig.height=4}
ggplot(res1)+geom_line( aes(year,hat))+
             geom_point(aes(year,obs))+
             geom_line( aes(year,hat),data=res2,col="red")+
  theme_bw()   
```

**Figure 10** Surplus production, lines are expected values (red is the non-stationary function) and points are the observered values. CV is `r as.integer(sd(log(res1$obs),na.rm=T)*100)` %


```{ralbn-om-ccf,fig.width=8,fig.height=6}
par(mfrow=c(2,2),mar=c(2,2,4,2))
with(dat,acf(Recruitment))
with(dat,acf(Production))
with(dat,ccf(Recruitment,Production))
```

**Figure 11** Auto and cross correlation for recruitment and production, showing production is driven by recruitment 5 to 10 years earlierand that although recruitment exhibits white noise there is autocorrelation in productivity.

```{r,fig.width=8,fig.height=4,eval=FALSE}
ggplot(spectra(dat$Recruitment))+
  geom_point(aes(f,mx))+
  theme_bw()

ggplot(spectra(dat$Production))+
  geom_point(aes(f,mx))+
  theme_bw()

**Figure** Spectra for production
```


```{ralbn-stars-rec,fig.width=8}
source('/home/laurie/Desktop/MEGA/papers/submitted/3stocks/v3/regimeShift.R')

res=rod(dat$Recruitment,dat$year)
```

**Figure 12** Shifts in recruitment

```{ralbn-stars-prod,fig.width=8}
res=rod(dat$Production,dat$year)
```
**Figure 13 ** Shifts in production


```{r}
load(paste(dirDat,"brs.RData",sep="/"))

refs=transform(ldply(brs, function(x) FLBRP:::refpts(x)["msy",1:5,drop=T]),
               .id=names(alb)[X1])[,-1]

save(refs,file=paste(dirDat,"refs.RData",sep="/"))

ts=ldply(alb, function(x) model.frame(FLQuants(x,"stock","ssb","catch","fbar","rec"),drop=T))
ts=merge(ts,refs,by=".id")
ts=transform(ts,stock  = stock/biomass,
                ssb    = ssb.x/ssb.y,
                catch  = catch/yield,
                harvest=(catch/stock)/(yield/biomass),
                f      =harvest/harvest,
                rec    =rec.x/rec.y)[,c(".id","year","stock","ssb","catch","harvest","f","rec")]
save(ts,file=paste(dirDat,"ts.RData",sep="/"))
```

```{ralbn-om-harvest,fig.width=8}
quads<- rbind(data.frame(x=c(-Inf,-Inf,Inf,Inf), y=c(-Inf,  1,  1,-Inf), 
                         fill=as.factor("green")),
              data.frame(x=c(-Inf,-Inf,Inf,Inf), y=c(   1,Inf,Inf,   1), 
                         fill=as.factor("red")))

ggplot(ts)+
  geom_polygon(data=quads,aes(x,y,fill=fill)) +
  scale_fill_manual(values = c("lightgreen","pink"), guide="none") +  
  geom_line(aes(year,harvest,group=.id))+
  facet_wrap(~.id)+
  ylab(expression(Harvest/H[MSY]))+
  xlab("Year")
```

**Figure 14** Harvest rate relative to MSY benchmark by scenario.


```{ralbn-om-biomass,fig.width=8}
ggplot(ts)+
  geom_polygon(data=quads,aes(x,y,fill=fill)) +
  scale_fill_manual(values = c("pink","lightgreen"), guide="none") +  
  geom_line(aes(year,harvest,group=.id))+
  facet_wrap(~.id)+
  ylab(expression(Biomass/B[MSY]))+
  xlab("Year")
```

**Figure 15** Stock biomass relative to MSY benchmark by scenario.

```{ralbn-om-k2pp}
kobePhase(ts)+
  geom_path(aes(stock,harvest,group=.id))+
  facet_wrap(~.id)+
  ylab(expression(Harvest/H[MSY]))+
  xlab(expression(Biomass/B[MSY]))
```

**Figure 16** Kobe Phase Plots by scenario
.